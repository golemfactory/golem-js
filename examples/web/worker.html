<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Golem Workers</title>
    <link rel="stylesheet" href="css/main.css" />
  </head>
  <body>
    <h1>Golem Workers</h1>
    <div class="container">
      <div class="col-6">
        <h3>Select Worker implementation</h3>
        <div id="options">
          <div class="col-12">
            <div class="fieldset">
              <div>
                <input type="radio" id="local" name="workerType" value="local" checked />
                <label for="local">Local (native browser)</label>
              </div>
              <div>
                <div class="inline">
                  <input type="radio" id="golem" name="workerType" value="golem" />
                  <label for="golem"> Golem (golem network)</label>
                </div>
                <div class="inline">
                  <label for="key"> Yagna App Key</label>
                  <input type="text" id="key" name="key" value="" />
                </div>
              </div>
            </div>
          </div>
        </div>
        <h3>Actions</h3>
        <div class="row inline">
          <button id="startWorker">Start Worker</button>
          <button id="stopWorker">Stop Worker</button>
          <div id="inputs" class="inline">
            <div class="inline">
              <label for="input">Input</label>
              <input type="text" id="input" name="input" />
            </div>
            <button id="post">></button>
          </div>
        </div>
        <div class="results console">
          <h3>Results</h3>
          <ul id="results"></ul>
        </div>
      </div>
      <div class="col-6 border-left">
        <div class="logs console">
          <h3>Logs</h3>
          <ul id="logs"></ul>
        </div>
      </div>
    </div>
    <script type="module">
      import { Worker as GolemWorker } from "/golem-js.min.js";
      let worker;
      const logger = {
        log: (msg) => appendLog(`[${new Date().toISOString()}] ${msg}`),
        warn: (msg) => appendLog(`[${new Date().toISOString()}] [warn] ${msg}`),
        debug: (msg) => null,
        error: (msg) => appendLog(`[${new Date().toISOString()}] [error] ${msg}`),
        info: (msg) => appendLog(`[${new Date().toISOString()}] [info] ${msg}`),
        table: (msg) => appendLog(JSON.stringify(msg, null, "\t")),
      };
      function startWorker() {
        const workerType = document.querySelector('input[name="workerType"]:checked');
        const apiKey = document.querySelector('input[name="key"]').value;
        worker =
          workerType.value === "golem"
            ? new GolemWorker("worker.js", { yagnaOptions: { apiKey }, logger })
            : new Worker("worker.js");
        worker.onmessage = (evt) => appendResults(`[worker] ${evt.data}`);
        worker.onerror = (error) => appendResults(`[worker:error] ${error}`);
      }
      function post() {
        const msg = document.querySelector("#input").value.toString().split(",");
        worker.postMessage(msg);
      }
      function stopWorker() {
        worker.terminate();
        worker = undefined;
      }
      export function appendResults(result) {
        const results_el = document.getElementById("results");
        const li = document.createElement("li");
        li.appendChild(document.createTextNode(result));
        results_el.appendChild(li);
      }
      function appendLog(msg) {
        const logs_el = document.getElementById("logs");
        const li = document.createElement("li");
        li.appendChild(document.createTextNode(msg));
        logs_el.appendChild(li);
      }
      document.querySelector("#startWorker").addEventListener("click", startWorker);
      document.querySelector("#stopWorker").addEventListener("click", stopWorker);
      document.querySelector("#post").addEventListener("click", post);
    </script>
  </body>
</html>
